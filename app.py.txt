import streamlit as st

# --- הגדרת משתנים קבועים ועלויות (החלק הסודי) ---
# חומר ציפוי רגיל
PRICE_PER_KG_POLUAL = 96.59
COVERAGE_POLUAL = 0.05  # ק"ג למ"ר

# פריימר (קשתות)
PRICE_PER_KG_PRIMER = 96.74
COVERAGE_PRIMER = 2.5   # ק"ג למ"ר (צריכה גבוהה לקשתות)

# עבודה וכללי
PREP_COST = 50          # הכנה לציפוי (קבוע)
LABOR_COST_PER_HOUR = 200
LABOR_COVERAGE = 1.5    # הספק עבודה: 1.5 מ"ר לשעה
OVERHEAD_FACTOR = 1.05  # תוספת 5% ייבוש והובלה פנימית
PROFIT_MARGIN = 1.55    # מכפיל רווח (55%)

# תוספת שטח (מתווסף בסוף, נטו)
FIELD_WORK_EXTRA = 2900

def calculate_price(length, height, depth, fpi, include_primer, is_field_work):
    # 1. חישוב שטח מצופה כללי (עבור Polual)
    # הנוסחה: אורך * גובה * עומק * FPI * 2
    coated_area = length * height * depth * fpi * 2
    
    # 2. עלות חומר Polual XT
    cost_polual = coated_area * COVERAGE_POLUAL * PRICE_PER_KG_POLUAL
    
    # 3. חישוב עלות פריימר (אם נבחר) - מתווסף לעלויות החומר
    cost_primer = 0
    if include_primer:
        # שטח לפריימר: גובה * עומק
        primer_area = height * depth
        cost_primer = primer_area * COVERAGE_PRIMER * PRICE_PER_KG_PRIMER
        
    # 4. חישוב עלות עבודה
    labor_hours = coated_area / LABOR_COVERAGE
    cost_labor = labor_hours * LABOR_COST_PER_HOUR
    
    # 5. סכום ביניים א' (חומרים + עבודה + הכנה קבועה)
    base_cost = cost_polual + cost_primer + cost_labor + PREP_COST
    
    # 6. תוספת ייבוש והובלה פנימית (5%)
    cost_with_overhead = base_cost * OVERHEAD_FACTOR
    
    # 7. הוספת רווח (55%) - זהו המחיר לפני תוספת שטח
    price_before_field = cost_with_overhead * PROFIT_MARGIN
    
    # 8. תוספת יציאה לשטח (אם נבחר) - מתווסף בסוף, "נקי"
    final_price = price_before_field
    if is_field_work:
        final_price += FIELD_WORK_EXTRA
        
    return int(final_price), coated_area

# --- עיצוב האפליקציה (מה שהלקוח רואה) ---
st.set_page_config(page_title="מחשבון בלייגולד", layout="centered", direction="rtl")

# כותרת ולוגו (טקסטואלי)
st.markdown("<h1 style='text-align: right;'>מחשבון הצעת מחיר - ציפוי סוללות</h1>", unsafe_allow_html=True)
st.markdown("<p style='text-align: right;'>הזן את נתוני הסוללה לקבלת הערכה מיידית</p>", unsafe_allow_html=True)
st.divider()

# --- טופס הקלט ---
col1, col2 = st.columns(2)

with col1:
    # רכיבים בצד ימין (או שמאל תלוי בדפדפן, סדר הגיוני)
    height = st.number_input("גובה הסוללה (מטר)", min_value=0.0, step=0.1, format="%.2f")
    depth = st.number_input("עומק/מספר שורות (מטר)", min_value=0.0, step=0.01, format="%.2f")

with col2:
    length = st.number_input("אורך הסוללה (מטר)", min_value=0.0, step=0.1, format="%.2f")
    fpi = st.number_input("צפיפות עלעלים (FPI)", min_value=1, value=12, step=1)

# אפשרויות נוספות
st.write("---")
st.markdown("<h5 style='text-align: right;'>אפשרויות נוספות</h5>", unsafe_allow_html=True)

# תיבת סימון לפריימר
include_primer = st.checkbox("כולל ציפוי קשתות (פריימר REFAMAC 3509)?")

# בחירת מיקום
location_option = st.radio(
    "מיקום ביצוע העבודה:",
    ["בית מלאכה (אצלנו)", "עבודת שטח (באתר הלקוח)"],
    horizontal=True
)

is_field_work = "שטח" in location_option

# כפתור חישוב
st.write("")
if st.button("חשב הצעת מחיר ₪", type="primary", use_container_width=True):
    if length > 0 and height > 0 and depth > 0:
        # ביצוע החישוב
        final_price, area_calc = calculate_price(length, height, depth, fpi, include_primer, is_field_work)
        
        # הצגת התוצאה
        st.success(f"הצעת מחיר משוערת: {final_price:,} ₪")
        
        # פרטים נוספים (אופציונלי להצגה ללקוח)
        with st.expander("פרטים נוספים על החישוב"):
            st.write(f"שטח מחושב לציפוי: {area_calc:.2f} מ\"ר")
            if include_primer:
                st.write("✅ כולל תוספת ציפוי קשתות (פריימר)")
            if is_field_work:
                st.write("✅ כולל תוספת יציאה לשטח")
            st.caption("המחיר אינו כולל מע\"מ. ט.ל.ח.")
            
    else:
        st.error("נא להזין מידות תקינות (גדולות מ-0)")